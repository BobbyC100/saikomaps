// schema.prisma — Saiko Maps Year 1 (Comprehensive)
// Includes: ALL existing tables + Year 1 contract additions
// Status: Safe migration - no data loss

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

//
// ═════════════════════════════════════════════════════════════════════════════
// CORE APP MODELS (Existing - Keep All)
// ═════════════════════════════════════════════════════════════════════════════
//

model users {
  id               String             @id
  email            String             @unique
  name             String?
  passwordHash     String?            @map("password_hash")
  avatarUrl        String?            @map("avatar_url")
  subscriptionTier String             @default("free") @map("subscription_tier")
  curatorNote      String?            @map("curator_note") @db.VarChar(140)
  scopePills       String[]           @default([]) @map("scope_pills")
  coverageSources  String[]           @default([]) @map("coverage_sources")
  createdAt        DateTime           @default(now()) @map("created_at")
  updatedAt        DateTime           @updatedAt @map("updated_at")
  import_jobs      import_jobs[]
  lists            lists[]
  viewer_bookmarks viewer_bookmarks[]
  saved_maps       saved_maps[]

  // Year 1 relations
  apiCallLogs     api_call_logs[]
  approvedSources sources[]       @relation("SourceApprovedBy")

  @@index([email])
}

model lists {
  id                  String           @id
  userId              String           @map("user_id")
  title               String
  subtitle            String?
  description         String?
  descriptionSource   String?          @map("description_source")
  slug                String           @unique
  introText           String?          @map("intro_text")
  functionType        String?          @map("function_type")
  functionContext     String?          @map("function_context")
  scopeGeography      String?          @map("scope_geography")
  scopePlaceTypes     String[]         @map("scope_place_types")
  scopeExclusions     String[]         @map("scope_exclusions")
  organizingLogic     OrganizingLogic? @map("organizing_logic")
  organizingLogicNote String?          @map("organizing_logic_note")
  notes               String?
  status              MapStatus        @default(DRAFT)
  publishedAt         DateTime?        @map("published_at")
  templateType        String           @default("field-notes") @map("template_type")
  coverImageUrl       String?          @map("cover_image_url")
  primaryColor        String           @default("#5BA7A7") @map("primary_color")
  secondaryColor      String           @default("#7FA5A5") @map("secondary_color")
  accessLevel         String           @default("public") @map("access_level")
  passwordHash        String?          @map("password_hash")
  allowedEmails       String[]         @map("allowed_emails")
  published           Boolean          @default(false)
  viewCount           Int              @default(0) @map("view_count")
  createdAt           DateTime         @default(now()) @map("created_at")
  updatedAt           DateTime         @updatedAt @map("updated_at")
  import_jobs         import_jobs[]
  users               users            @relation(fields: [userId], references: [id], onDelete: Cascade)
  locations           locations[]
  map_places          map_places[]
  saved_maps          saved_maps[]

  // Year 1 relations
  apiCallLogs api_call_logs[]

  @@index([published])
  @@index([slug])
  @@index([status])
  @@index([userId])
}

model places {
  id                     String      @id
  slug                   String      @unique
  googlePlaceId          String?     @unique @map("google_place_id")
  name                   String
  address                String?
  latitude               Decimal?    @db.Decimal(10, 8)
  longitude              Decimal?    @db.Decimal(11, 8)
  phone                  String?
  website                String?
  instagram              String?
  hours                  Json?
  description            String?
  googlePhotos           Json?       @map("google_photos")
  googleTypes            String[]    @default([]) @map("google_types")
  priceLevel             Int?        @map("price_level")
  neighborhood           String?
  category               String?
  placesDataCachedAt     DateTime?   @map("places_data_cached_at")
  createdAt              DateTime    @default(now()) @map("created_at")
  updatedAt              DateTime    @updatedAt @map("updated_at")
  editorialSources       Json?       @map("editorial_sources")
  cuisineType            String?     @map("cuisine_type")
  adUnitOverride         Boolean     @default(false) @map("ad_unit_override")
  adUnitType             String?     @map("ad_unit_type")
  pullQuote              String?     @map("pull_quote")
  pullQuoteAuthor        String?     @map("pull_quote_author")
  pullQuoteSource        String?     @map("pull_quote_source")
  pullQuoteType          String?     @map("pull_quote_type")
  pullQuoteUrl           String?     @map("pull_quote_url")
  tagline                String?
  taglineCandidates      String[]    @default([]) @map("tagline_candidates")
  taglineGenerated       DateTime?   @map("tagline_generated")
  taglinePattern         String?     @map("tagline_pattern")
  taglineSignals         Json?       @map("tagline_signals")
  tips                   String[]    @default([])
  vibeTags               String[]    @default([]) @map("vibe_tags")
  chefRecs               Json?       @map("chef_recs")
  restaurantGroupId      String?     @map("restaurant_group_id")
  status                 PlaceStatus @default(OPEN)
  intentProfile          String?     @map("intent_profile")
  intentProfileOverride  Boolean     @default(false) @map("intent_profile_override")
  reservationUrl         String?     @map("reservation_url")
  googlePlacesAttributes Json?       @map("google_places_attributes")

  // Geographic data (existing columns to preserve)
  city    String?
  state   String?
  county  String?
  region  String?
  zip     String?
  scope   PlaceScope @default(active)
  country String?

  // ─────────────────────────────────────────────────────────────────────────
  // YEAR 1 ADDITIONS: Multi-city + Neighborhood + SaikoAI Provenance
  // ─────────────────────────────────────────────────────────────────────────
  cityId                   String?   @map("city_id")
  neighborhoodId           String?   @map("neighborhood_id")
  neighborhoodOverride     String?   @map("neighborhood_override")
  saikoSummary             String?   @map("saiko_summary")
  saikoSummaryGeneratedAt  DateTime? @map("saiko_summary_generated_at")
  saikoSummaryModelVersion String?   @map("saiko_summary_model_version")
  saikoSummaryCoverageIds  String[]  @default([]) @map("saiko_summary_coverage_ids")

  // ─────────────────────────────────────────────────────────────────────────
  // RANKING SYSTEM: Non-algorithmic editorial scoring
  // ─────────────────────────────────────────────────────────────────────────
  rankingScore      Float?    @map("ranking_score") @default(0)
  lastScoreUpdate   DateTime? @map("last_score_update")

  map_places        map_places[]
  person_places     person_places[]
  restaurant_groups restaurant_groups? @relation(fields: [restaurantGroupId], references: [id])
  viewer_bookmarks  viewer_bookmarks[]

  // Year 1 relations
  cityRel         cities?           @relation(fields: [cityId], references: [id])
  neighborhoodRel neighborhoods?    @relation(fields: [neighborhoodId], references: [id])
  coverages       place_coverages[]
  apiCallLogs     api_call_logs[]

  @@index([category])
  @@index([googlePlaceId])
  @@index([neighborhood])
  @@index([restaurantGroupId])
  @@index([status])
  @@index([cityId])
  @@index([neighborhoodId])
  @@index([rankingScore(sort: Desc)])
}

model map_places {
  id         String   @id
  mapId      String   @map("map_id")
  placeId    String   @map("place_id")
  descriptor String?  @db.VarChar(120)
  userNote   String?  @map("user_note")
  userPhotos String[] @map("user_photos")
  orderIndex Int      @default(0) @map("order_index")
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")
  lists      lists    @relation(fields: [mapId], references: [id], onDelete: Cascade)
  places     places   @relation(fields: [placeId], references: [id])

  @@unique([mapId, placeId])
  @@index([mapId])
  @@index([mapId, orderIndex])
  @@index([placeId])
}

model locations {
  id                 String    @id
  listId             String    @map("list_id")
  googlePlaceId      String?   @map("google_place_id")
  name               String
  address            String?
  latitude           Decimal?  @db.Decimal(10, 8)
  longitude          Decimal?  @db.Decimal(11, 8)
  phone              String?
  website            String?
  instagram          String?
  hours              Json?
  description        String?
  googleTypes        String[]  @default([]) @map("google_types")
  priceLevel         Int?      @map("price_level")
  neighborhood       String?
  googlePhotos       Json?     @map("google_photos")
  userPhotos         String[]  @map("user_photos")
  userNote           String?   @map("user_note")
  category           String?
  descriptor         String?
  orderIndex         Int       @default(0) @map("order_index")
  placesDataCachedAt DateTime? @map("places_data_cached_at")
  createdAt          DateTime  @default(now()) @map("created_at")
  updatedAt          DateTime  @updatedAt @map("updated_at")
  lists              lists     @relation(fields: [listId], references: [id], onDelete: Cascade)

  @@index([googlePlaceId])
  @@index([listId, category])
  @@index([listId])
  @@index([listId, orderIndex])
}

model import_jobs {
  id                 String    @id
  userId             String    @map("user_id")
  listId             String?   @map("list_id")
  status             String    @default("processing")
  totalLocations     Int?      @map("total_locations")
  processedLocations Int       @default(0) @map("processed_locations")
  failedLocations    Int       @default(0) @map("failed_locations")
  errorLog           Json?     @map("error_log")
  createdAt          DateTime  @default(now()) @map("created_at")
  completedAt        DateTime? @map("completed_at")
  lists              lists?    @relation(fields: [listId], references: [id])
  users              users     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([status])
  @@index([userId])
}

model saved_maps {
  id      String   @id @default(cuid())
  userId  String   @map("user_id")
  listId  String   @map("list_id")
  savedAt DateTime @default(now()) @map("saved_at")
  users   users    @relation(fields: [userId], references: [id], onDelete: Cascade)
  lists   lists    @relation(fields: [listId], references: [id], onDelete: Cascade)

  @@unique([userId, listId])
  @@index([userId])
  @@index([listId])
}

model viewer_bookmarks {
  id           String   @id
  viewerUserId String?  @map("viewer_user_id")
  placeId      String   @map("place_id")
  visited      Boolean  @default(false)
  personalNote String?  @map("personal_note")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")
  places       places   @relation(fields: [placeId], references: [id], onDelete: Cascade)
  users        users?   @relation(fields: [viewerUserId], references: [id], onDelete: Cascade)

  @@unique([viewerUserId, placeId])
  @@index([placeId])
  @@index([viewerUserId])
}

model activity_spots {
  id          String     @id
  name        String
  slug        String?    @unique
  latitude    Float
  longitude   Float
  layer_type  LayerType
  city        String?
  region      String?
  country     String     @default("US")
  spot_type   String?
  tags        String[]
  surface     String?
  skill_level String?
  exposure    String?
  description String?
  seasonality String?
  is_public   Boolean    @default(true)
  source      SpotSource
  source_id   String?
  source_url  String?
  verified    Boolean    @default(false)
  enabled     Boolean    @default(true)
  created_at  DateTime   @default(now())
  updated_at  DateTime   @updatedAt

  @@index([layer_type, city])
  @@index([layer_type, latitude, longitude])
  @@index([source, source_id])
}

//
// ═════════════════════════════════════════════════════════════════════════════
// PEOPLE & RESTAURANT GROUPS (Existing - Keep All)
// ═════════════════════════════════════════════════════════════════════════════
//

model people {
  id                  String             @id
  name                String
  slug                String             @unique
  role                PersonRole
  visibility          Visibility
  bio                 String?
  image_url           String?
  sources             Json
  restaurant_group_id String?
  created_at          DateTime           @default(now())
  updated_at          DateTime           @updatedAt
  restaurant_groups   restaurant_groups? @relation(fields: [restaurant_group_id], references: [id])
  person_places       person_places[]

  @@index([restaurant_group_id])
  @@index([slug])
  @@index([visibility])
}

model person_places {
  id         String          @id
  person_id  String
  place_id   String
  role       PersonPlaceRole
  current    Boolean         @default(true)
  start_year Int?
  end_year   Int?
  source     String
  created_at DateTime        @default(now())
  updated_at DateTime        @updatedAt
  people     people          @relation(fields: [person_id], references: [id], onDelete: Cascade)
  places     places          @relation(fields: [place_id], references: [id], onDelete: Cascade)

  @@unique([person_id, place_id, role])
  @@index([current])
  @@index([person_id])
  @@index([place_id])
}

model restaurant_groups {
  id                      String     @id
  name                    String
  slug                    String     @unique
  visibility              Visibility
  description             String?
  anchor_city             String?
  website                 String?
  location_count_estimate Int?
  sources                 Json
  created_at              DateTime   @default(now())
  updated_at              DateTime   @updatedAt
  people                  people[]
  places                  places[]

  @@index([slug])
  @@index([visibility])
}

//
// ═════════════════════════════════════════════════════════════════════════════
// ENTITY RESOLUTION PIPELINE (Existing - Keep All)
// ═════════════════════════════════════════════════════════════════════════════
//

model raw_records {
  raw_id          String    @id @default(uuid())
  source_name     String
  external_id     String?
  source_url      String?
  placekey        String?
  h3_index_r9     BigInt?
  h3_neighbors_r9 BigInt[]
  raw_json        Json
  name_normalized String?
  lat             Decimal?  @db.Decimal(10, 7)
  lng             Decimal?  @db.Decimal(11, 7)
  observed_at     DateTime?
  ingested_at     DateTime  @default(now())
  is_processed    Boolean   @default(false)

  entity_links_from entity_links[]
  review_queue_a    review_queue[] @relation("ReviewQueueRecordA")
  review_queue_b    review_queue[] @relation("ReviewQueueRecordB")

  @@unique([source_name, external_id])
  @@index([h3_index_r9])
  @@index([placekey])
  @@index([is_processed])
  @@index([name_normalized])
}

model entity_links {
  canonical_id     String
  raw_id           String
  match_confidence Decimal? @db.Decimal(4, 3)
  match_method     String
  match_features   Json?
  is_active        Boolean  @default(true)
  linked_at        DateTime @default(now())
  linked_by        String?

  raw_record    raw_records    @relation(fields: [raw_id], references: [raw_id])
  golden_record golden_records @relation(fields: [canonical_id], references: [canonical_id])

  @@id([canonical_id, raw_id])
  @@index([raw_id])
  @@index([canonical_id])
  @@index([match_method])
}

model golden_records {
  canonical_id                        String          @id @default(uuid())
  placekey                            String?         @unique
  google_place_id                     String?
  slug                                String          @unique
  name                                String
  name_display                        String?
  lat                                 Decimal         @db.Decimal(10, 7)
  lng                                 Decimal         @db.Decimal(11, 7)
  address_street                      String?
  address_city                        String?
  address_state                       String?
  address_zip                         String?
  neighborhood                        String?
  category                            String?
  cuisines                            String[]
  price_level                         Int?
  phone                               String?
  website                             String?
  instagram_handle                    String?
  hours_json                          Json?
  hours_irregular                     Boolean         @default(false)
  description                         String?
  vibe_tags                           String[]
  signature_dishes                    String[]
  pro_tips                            String[]
  pull_quote                          String?
  pull_quote_source                   String?
  pull_quote_url                      String?
  business_status                     String          @default("operational")
  lifecycle_status                    LifecycleStatus @default(ACTIVE) @map("lifecycle_status")
  archive_reason                      ArchiveReason?  @map("archive_reason")
  archived_at                         DateTime?       @map("archived_at")
  archived_by                         String?         @map("archived_by")
  source_attribution                  Json
  created_at                          DateTime        @default(now())
  updated_at                          DateTime        @updatedAt
  last_resolved_at                    DateTime?
  enriched_at                         DateTime?
  county                              String?
  data_completeness                   Decimal?        @db.Decimal(3, 2)
  source_count                        Int             @default(1)
  menu_url                            String?
  menu_source_url                     String?
  menu_raw_text                       String?
  winelist_url                        String?
  winelist_source_url                 String?
  winelist_raw_text                   String?
  about_copy                          String?
  about_source_url                    String?
  scraped_at                          DateTime?
  scrape_status                       String?
  cuisine_posture                     String?
  service_model                       String?
  price_tier                          String?
  wine_program_intent                 String?
  place_personality                   String?
  identity_signals                    Json?
  signals_generated_at                DateTime?
  signals_version                     Int?
  signals_reviewed                    Boolean         @default(false)
  signals_reviewed_by                 String?
  signals_reviewed_at                 DateTime?
  tagline                             String?
  tagline_candidates                  String[]        @default([])
  tagline_pattern                     String?
  tagline_generated_at                DateTime?
  tagline_signals                     Json?
  tagline_version                     Int?
  google_places_attributes            Json?
  google_places_attributes_fetched_at DateTime?

  entity_links entity_links[]
  review_queue review_queue[]
  provenance   provenance[]

  @@index([neighborhood])
  @@index([category])
  @@index([business_status])
  @@index([slug])
}

model review_queue {
  queue_id           String    @id @default(uuid())
  canonical_id       String?
  raw_id_a           String
  raw_id_b           String?
  conflict_type      String
  match_confidence   Decimal?  @db.Decimal(4, 3)
  conflicting_fields Json?
  priority           Int       @default(5)
  status             String    @default("pending")
  resolution         String?
  resolution_notes   String?
  created_at         DateTime  @default(now())
  assigned_to        String?
  resolved_by        String?
  resolved_at        DateTime?

  golden_record golden_records?    @relation(fields: [canonical_id], references: [canonical_id])
  raw_record_a  raw_records        @relation("ReviewQueueRecordA", fields: [raw_id_a], references: [raw_id])
  raw_record_b  raw_records?       @relation("ReviewQueueRecordB", fields: [raw_id_b], references: [raw_id])
  audit_logs    review_audit_log[]

  @@index([status])
  @@index([priority, status])
  @@index([canonical_id])
}

model review_audit_log {
  log_id           String       @id @default(uuid())
  queue_id         String
  resolved_by      String
  resolution       String
  decision_time_ms Int?
  resolved_at      DateTime     @default(now())
  review_queue     review_queue @relation(fields: [queue_id], references: [queue_id])

  @@index([queue_id])
  @@index([resolved_at])
}

model provenance {
  id                  String             @id @default(cuid())
  place_id            String             @map("place_id")
  added_by            String             @map("added_by")
  source_type         String?            @map("source_type")
  source_name         String?            @map("source_name")
  source_url          String?            @map("source_url")
  source_date         DateTime?          @map("source_date")
  notes               String?
  import_batch        String?            @map("import_batch")
  source_tier         Int?               @map("source_tier")
  verification_status VerificationStatus @default(UNVERIFIED) @map("verification_status")
  source_verified_at  DateTime?          @map("source_verified_at")
  source_verified_by  String?            @map("source_verified_by")
  created_at          DateTime           @default(now()) @map("created_at")
  golden_record       golden_records     @relation(fields: [place_id], references: [canonical_id], onDelete: Cascade)

  @@index([place_id])
  @@index([added_by])
  @@index([import_batch])
}

//
// ═════════════════════════════════════════════════════════════════════════════
// YEAR 1 CONTRACT TABLES (New - Safe to Add)
// ═════════════════════════════════════════════════════════════════════════════
//

model countries {
  id        String   @id @default(cuid())
  code      String   @unique
  name      String
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  cities    cities[]
}

model cities {
  id        String   @id @default(cuid())
  countryId String   @map("country_id")
  slug      String   @unique
  name      String
  locale    String   @default("en")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  country       countries         @relation(fields: [countryId], references: [id])
  neighborhoods neighborhoods[]
  places        places[]
  coverages     place_coverages[]
}

model neighborhoods {
  id        String   @id @default(cuid())
  cityId    String   @map("city_id")
  slug      String
  name      String
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  city   cities   @relation(fields: [cityId], references: [id])
  places places[]

  @@unique([cityId, slug])
  @@index([cityId])
}

model sources {
  id               String       @id @default(cuid())
  name             String       @unique
  type             SourceType
  status           SourceStatus @default(PENDING)
  approvedAt       DateTime?    @map("approved_at")
  approvedByUserId String?      @map("approved_by_user_id")
  createdAt        DateTime     @default(now()) @map("created_at")
  updatedAt        DateTime     @updatedAt @map("updated_at")

  approvedBy users?            @relation("SourceApprovedBy", fields: [approvedByUserId], references: [id])
  coverages  place_coverages[]

  @@index([status])
}

model place_coverages {
  id          String         @id @default(cuid())
  placeId     String         @map("place_id")
  sourceId    String         @map("source_id")
  cityId      String         @map("city_id")
  url         String
  title       String?
  publishedAt DateTime?      @map("published_at")
  excerpt     String?
  quote       String?
  quoteAuthor String?        @map("quote_author")
  status      CoverageStatus @default(PENDING)
  createdAt   DateTime       @default(now()) @map("created_at")
  updatedAt   DateTime       @updatedAt @map("updated_at")

  place  places  @relation(fields: [placeId], references: [id], onDelete: Cascade)
  source sources @relation(fields: [sourceId], references: [id])
  city   cities  @relation(fields: [cityId], references: [id])

  @@index([placeId])
  @@index([sourceId])
  @@index([cityId])
  @@index([status])
}

model tags {
  id        String    @id @default(cuid())
  slug      String    @unique
  name      String
  status    TagStatus @default(ACTIVE)
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")

  @@index([status])
}

model api_call_logs {
  id               String     @id @default(cuid())
  provider         String
  endpoint         String
  trigger          ApiTrigger
  actorUserId      String?    @map("actor_user_id")
  placeId          String?    @map("place_id")
  mapId            String?    @map("map_id")
  jobId            String?    @map("job_id")
  requestHash      String?    @map("request_hash")
  estimatedCostUsd Decimal?   @map("estimated_cost_usd") @db.Decimal(10, 4)
  createdAt        DateTime   @default(now()) @map("created_at")

  actor users?  @relation(fields: [actorUserId], references: [id])
  place places? @relation(fields: [placeId], references: [id])
  map   lists?  @relation(fields: [mapId], references: [id])

  @@index([provider, createdAt])
  @@index([placeId])
  @@index([mapId])
}

//
// ═════════════════════════════════════════════════════════════════════════════
// ENUMS (Existing + New for Year 1)
// ═════════════════════════════════════════════════════════════════════════════
//

// Existing enums (keep ALL values - critical!)
enum PlaceStatus {
  OPEN
  CLOSED
  PERMANENTLY_CLOSED
}

enum MapStatus {
  DRAFT
  READY
  PUBLISHED
  ARCHIVED
}

enum OrganizingLogic {
  TIME_BASED
  NEIGHBORHOOD_BASED
  ROUTE_BASED
  PURPOSE_BASED
  LAYERED
}

enum LayerType {
  SKATE
  SURF
}

enum SpotSource {
  OSM
  CITY_DATA
  EDITORIAL
  COMMUNITY
}

enum PersonRole {
  CHEF
  OWNER
  OPERATOR
  FOUNDER
  PARTNER
}

enum PersonPlaceRole {
  EXECUTIVE_CHEF
  OWNER
  FOUNDER
  FORMER_CHEF
  PARTNER
  OPERATOR
}

enum Visibility {
  INTERNAL
  VERIFIED
}

enum LifecycleStatus {
  ACTIVE
  LEGACY_FAVORITE
  FLAG_FOR_REVIEW
  ARCHIVED
  CLOSED_PERMANENTLY
}

enum ArchiveReason {
  CLOSED
  AGED_OUT
  QUALITY_DECLINE
  DATA_ERROR
  MANUAL
}

enum VerificationStatus {
  UNVERIFIED
  SOURCE_CONFIRMED
  FOUNDER_VERIFIED
}

// Year 1 contract enums (new)
enum SourceType {
  PUBLICATION
  VIDEO_CHANNEL
  BLOG
  INSTAGRAM
  OTHER
}

enum SourceStatus {
  PENDING
  APPROVED
  DISABLED
}

enum CoverageStatus {
  PENDING
  APPROVED
  DISABLED
}

enum TagStatus {
  ACTIVE
  DISABLED
}

enum ApiTrigger {
  MANUAL
  JOB
  USER_ACTION
}

enum PlaceScope {
  active
  archive
  future_region
  hidden
}
